<?php
/**
 * @file
 * @todo Comentar todas as funcións, refactorifar noutro ficheiros e pasar Code_Sniffer
 */

function proxecto13_page_alter(&$page) {
  // Move search form into the footer.
  //var_dump($page);
}

/**
 *
 */ 
function proxecto13_menu() {
  // Páxina principal
  $items['proxecto13'] = array(
    'title' => 'Proxecto 13',
    'page callback' => 'proxecto13_callback',
    'file' => 'proxecto13_callback.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  
  $items['proxecto13/contorno'] = array(
    'title' => 'Modificar Contorno',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('proxecto13_form_contorno'),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['proxecto13/usuario'] = array(
    'title' => 'Engadir Usuario',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('proxecto13_form_usuario'),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['proxecto13/404'] = array(
    'title' => '404 not found',
    'page callback' => 'proxecto13_404_callback',
    'file' => 'proxecto13_40X_callback.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['proxecto13/403'] = array(
    'title' => '403 forbidden',
    'page callback' => 'proxecto13_403_callback',
    'file' => 'proxecto13_40X_callback.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['proxecto13/cron'] = array(
    'page callback' => 'proxecto13_cron_ajax',
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
  );
  
  return $items;
}

function proxecto13_cron_ajax() {

  $result = drupal_cron_run();

  $data = array(
    'success'   => $result,
    'cron_last' => date('d/m/Y H:i:s', variable_get('cron_last'))
  );

  drupal_json_output($data);
}


function proxecto13_theme($existing, $type, $theme, $path){
  global $base_url;

  return array(
    'proxecto13' => array(
        'template' => 'proxecto13',

        'variables' => array(
          'base_url'   => $base_url,

          'user'       => NULL,
          'acceso'     => NULL,
          'picture'    => NULL,

          'localidade' => NULL,
          'enderezo'   => NULL,
          'idade'      => NULL,
          'mobil'      => NULL,

          'site_name'   => NULL,
          'site_slogan' => NULL,

          'admin' => NULL,
          'install_profile' => NULL,
          'cron_last' => NULL,
          'cron_key' => NULL,
          'site_404' => NULL,
          'site_403' => NULL,
        ),

        'path' => drupal_get_path('module', 'proxecto13'),
     ),

     'proxecto13-404' => array(
       'template' => 'proxecto13-404',
       'variables' => array(
         'base_url' => $base_url,
       ),
       'path' => drupal_get_path('module', 'proxecto13'),
     ),

     
     'proxecto13-403' => array(
       'template' => 'proxecto13-403',
       'variables' => array(
         'base_url' => $base_url,
       ),
       'path' => drupal_get_path('module', 'proxecto13'),
     ),
  );

}

/**
 *
 */
function proxecto13_form_contorno($node, &$form_state) {
  $site_name   = variable_get('site_name', '');
  $site_slogan = variable_get('site_slogan', '');

  // Yoda expressions: Comparar tu puedes, padawan!
  $site_404 = ('' !== variable_get('site_404', ''));
  $site_403 = ('' !== variable_get('site_403', ''));

  $form['nome'] = array(
    '#title'         => t('Nome do sitio'),
    '#type'          => 'textfield',
    '#required'      => TRUE,
    '#description'   => t('Nome do sitio'),
    '#default_value' => $site_name,
  );
  
  $form['slogan'] = array(
    '#title'         => t('Slogan do sitio'),
    '#type'          => 'textfield',
    '#description'   => t('Slogan do sitio'),
    '#default_value' => $site_slogan,
  );
  
  $form['on404'] = array(
    '#title'         => t('Activar páxina 404'),
    '#type'          => 'checkbox',
    '#default_value' => $site_404,
  ); 
   
  $form['on403'] = array(
    '#title'         => t('Activar páxina 403'),
    '#type'          => 'checkbox',
    '#default_value' => $site_403,
  );
  
  $form['submit'] = array(
    '#type'  => 'submit',
    '#value' => t('Enviar'),
  );
  
  return $form;
}

function proxecto13_form_contorno_validate($form, &$form_state) {

}

/**
 * @param $form
 * @param $form_state
 */
function proxecto13_form_contorno_submit($form, &$form_state) {
  firep($form_state);

  $site_name = check_plain($form_state['values']['nome']);
  variable_set('site_name', $site_name);

  $site_slogan = check_plain($form_state['values']['slogan']);
  variable_set('site_slogan', $site_slogan);

  if(!empty($form_state['values']['on404'])) {
    variable_set('site_404', 'proxecto13/404');
  } else {
    variable_set('site_404', '');
  }

  if(!empty($form_state['values']['on403'])) {
    variable_set('site_403', 'proxecto13/403');
  } else {
    variable_set('site_403', '');
  }

  drupal_set_message(t('Valores do contorno gardados correctamente.'), 'status');
  drupal_goto('proxecto13');
}

function proxecto13_form_usuario($node, &$form_state) {

  $form['user_name'] = array(
    '#title'       => t('Nome de usuario'),    
    '#type'        => 'textfield',
    '#required'    => TRUE,
    '#description' => t('Nome de usuario'),    
  );

  $form['mail'] = array(
    '#title'       => t('Email'),    
    '#type'        => 'textfield',
    '#required'    => TRUE,
    '#description' => t('Enderezo electrónico'),    
  );

  $form['localidade'] = array(
    '#title'       => t('Localidade'),    
    '#type'        => 'textfield',
    '#description' => t('Localidade'),    
  );

  $form['idade'] = array(
    '#title'       => t('Idade'),    
    '#type'        => 'textfield',
    '#description' => t('Idade'),    
  );

  $form['telefono'] = array(
    '#title'       => t('Teléfono'),    
    '#type'        => 'textfield',
    '#description' => t('Teléfono'),    
  );  
  
  $form['submit'] = array(
    '#type'  => 'submit',
    '#value' => t('Enviar'),
  );
  
  return $form;
}

function proxecto13_form_usuario_validate($form, &$form_state) {

  if($error = user_validate_name($form_state['values']['user_name'])) {
    form_set_error('user_name', $error);
  }

  if($error = user_validate_mail($form_state['values']['mail'])) {
    form_set_error('mail', $error);
  }

}

function proxecto13_form_usuario_submit($form, &$form_state) {
  require DRUPAL_ROOT . '/includes/password.inc';

  $user_name = check_plain($form_state['values']['user_name']);

  $account = new stdClass;
  $account->is_new = TRUE;
  $account->name = $user_name;
  $account->pass = '12345'; //user_hash_password($password);
  $account->mail = $form_state['values']['mail'];
  $account->init = $form_state['values']['mail'];
  $account->status = TRUE;
  $account->roles = array(DRUPAL_AUTHENTICATED_RID => TRUE);
  //$account->timezone = variable_get('date_default_timezone', '');

  $edit = array();
  $edit['field_localidade'][LANGUAGE_NONE][0]['value'] = $form_state['values']['localidade'];
  $edit['field_idade'][LANGUAGE_NONE][0]['value']      = $form_state['values']['idade'];
  $edit['field_telefono'][LANGUAGE_NONE][0]['value']   = $form_state['values']['telefono'];

  if (FALSE === user_save($account, $edit)) {
    // Apareceu algún erro ao procesar o formularios
    $message = t('Apareceu un erro ao tentar crear a conta de usuario: %user_name.',
      array('%user_name' => $user_name));
    drupal_set_message($message, 'error');
    watchdog('proxecto13', $message);

  } else {
    // Usuario creado correctamente
    $message = t('Usuario %user_name creado correctamente.', array('%user_name' => $user_name));
    drupal_set_message($message, 'status');
    watchdog('proxecto13', $message);
    drupal_goto('proxecto13');
  }

}

/**
 * Implements hook_form_alter().
 */
function proxecto13_form_alter(&$form, &$form_state, $form_id) {
  if('user_profile_form' == $form_id) {
    drupal_set_title('Modificación perfíl proxecto OSL');
  }
}
